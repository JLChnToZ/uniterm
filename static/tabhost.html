<!doctype html>
<HTML>
<Head>
<Title>Termhost</Title>
</Head>
<Body>
<div class="etabs-tabgroup">
<div class="etabs-tabs"></div>
<div class="etabs-buttons"><button id="options">O</button></div>
</div>
<div class="etabs-views"></div>
<style>
@import url(../node_modules/electron-tabs/electron-tabs.css);
@import url(../node_modules/dragula/dist/dragula.css);
html, body {
  height: 100%;
  border: 0 none;
  margin: 0;
  padding: 0;
}
</style>
<script>
(function() {
  const { ipcRenderer } = require('electron');
  const TabGroup = require('electron-tabs');
  const dragula = require('dragula');
  const contextMenu = require('../lib/defaultcontextmenu');
  let tabCount = 0;
  let optionsTab;
  function addTab() {
    tabGroup.addTab();
  }
  function showOptionsTab() {
    if(optionsTab) return;
    optionsTab = tabGroup.addTab({
      src: 'ttyconfig.html',
      title: 'TTY Host',
      active: true,
      webviewAttributes: {
        nodeintegration: true
      }
    });
  }
  function setTitle(title) {
    document.title = (title.length ? `${title} - ` : '') + 'Uniterm';
  }
  function dropBlocker(e) {
    e.preventDefault();
    e.stopPropagation();
    if(e.dataTransfer)
      e.dataTransfer.dropEffect = 'none';
    return false;
  }
  function tabAdded(tab, group) {
    tabCount++;
    tab.webview.addEventListener('close', () => tab.close(true));
    tab.webview.addEventListener('page-title-updated', e => {
      tab.setTitle(e.title);
      if(tab === tabGroup.getActiveTab())
        setTitle(e.title);
    });
    tab.webview.addEventListener('dragover', dropBlocker, false);
    tab.webview.addEventListener('drop', dropBlocker, false);
    tab.webview.addEventListener('dom-ready', () => contextMenu.register(tab.webview, tab.webview.getWebContents()));
    tab.on('closing', tabClosing);
  }
  function tabActive(tab, group) {
    setTitle(tab.getTitle());
    tab.webview.focus();
  }
  function tabClosing(tab) {
    if(tab === optionsTab)
      optionsTab = undefined;
    ipcRenderer.send('end', tab.webview.getWebContents().id);
  }
  function tabRemoved(tab, group) {
    tabCount--;
    if(tabCount <= 0) window.close();
  }
  const tabGroup = new TabGroup({
    ready(tabGroup) {
      dragula([tabGroup.tabContainer], {
        direction: 'horizontal'
      });
    },
    newTab: {
      src: 'index.html',
      title: 'TTY Host',
      active: true,
      webviewAttributes: {
        nodeintegration: true
      }
    }
  });
  tabGroup.on('tab-added', tabAdded);
  tabGroup.on('tab-active', tabActive);
  tabGroup.on('tab-removed', tabRemoved);
  ipcRenderer.on('addtab', addTab);
  ipcRenderer.on('showoptions', showOptionsTab);
  document.getElementById('options').addEventListener('click', showOptionsTab);

  document.addEventListener('dragover', dropBlocker, false);
  document.addEventListener('drop', dropBlocker, false);
})();
</script>
</Body>
</HTML>
